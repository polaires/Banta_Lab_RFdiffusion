# Local Docker Testing for RFdiffusion Serverless
#
# Prerequisites:
#   1. Docker Desktop with WSL2 backend
#   2. NVIDIA GPU drivers installed
#   3. NVIDIA Container Toolkit (nvidia-docker2)
#
# Usage:
#   docker-compose -f docker-compose.local.yml up --build
#
# Test with:
#   curl http://localhost:8000/runsync -X POST -H "Content-Type: application/json" \
#     -d '{"input": {"task": "health"}}'

services:
  rfdiffusion:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      # Mount WSL checkpoints directory (adjust path as needed)
      # Option 1: From WSL path (when running docker from WSL)
      - /home/polaire/.foundry/checkpoints:/runpod-volume/checkpoints
      # Option 2: If running from Windows, use: //wsl.localhost/Ubuntu/home/polaire/.foundry/checkpoints
      # Mount source code for live editing
      - ./handler.py:/app/handler.py
      - ./inference_utils.py:/app/inference_utils.py
      - ./design_types.py:/app/design_types.py
      - ./design_orchestrator.py:/app/design_orchestrator.py
      - ./geometry_validation.py:/app/geometry_validation.py
      - ./architector_integration.py:/app/architector_integration.py
      - ./binding_analysis.py:/app/binding_analysis.py
      - ./conformer_utils.py:/app/conformer_utils.py
      - ./cleavage_utils.py:/app/cleavage_utils.py
      - ./hotspot_detection.py:/app/hotspot_detection.py
      - ./rosetta_utils.py:/app/rosetta_utils.py
      - ./topology_validation.py:/app/topology_validation.py
      - ./esm_utils.py:/app/esm_utils.py
      - ./esmfold_utils.py:/app/esmfold_utils.py
      # Design analysis
      - ./unified_analyzer.py:/app/unified_analyzer.py
      - ./analysis_types.py:/app/analysis_types.py
      - ./design_validation_pipeline.py:/app/design_validation_pipeline.py
      # Lanthanide design modules (Caldwell et al. 2020)
      - ./lanthanide_templates.py:/app/lanthanide_templates.py
      - ./metal_validation.py:/app/metal_validation.py
      # Metal-ligand complex design modules
      - ./metal_ligand_templates.py:/app/metal_ligand_templates.py
      - ./test_metal_ligand_complex.py:/app/test_metal_ligand_complex.py
      # Metal binding pipeline (Round 7b monomer workflow)
      - ./metal_binding_pipeline.py:/app/metal_binding_pipeline.py
      - ./tebl_analysis.py:/app/tebl_analysis.py
      - ./hbplus_utils.py:/app/hbplus_utils.py
      # AI Design Pipeline (Natural Language -> RFD3 -> MPNN -> Validation)
      - ./nl_design_parser.py:/app/nl_design_parser.py
      - ./ligand_resolver.py:/app/ligand_resolver.py
      - ./rfd3_config_generator.py:/app/rfd3_config_generator.py
      - ./ai_design_pipeline.py:/app/ai_design_pipeline.py
      - ./metal_chemistry.py:/app/metal_chemistry.py
      - ./ligand_donors.py:/app/ligand_donors.py
      - ./design_rules.py:/app/design_rules.py
      # Mount utils directory for SASA calculations
      - ../utils:/app/utils
      - ../utils/dssp.py:/app/dssp.py
      # Mount shared package (interaction analysis module)
      - ./shared:/app/shared
      # Mount experiments directory for testing
      - /mnt/g/Github_local_repo/Banta_Lab_RFdiffusion/experiments:/experiments
      # Mount CCD data for LigandMPNN
      - /home/polaire/pdbsum1/data:/data/ccd
    environment:
      - CHECKPOINT_DIR=/runpod-volume/checkpoints
      - FOUNDRY_CHECKPOINT_DIRS=/runpod-volume/checkpoints
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - HF_TOKEN=${HF_TOKEN:-}
      # CCD and PDB mirrors for LigandMPNN ligand handling
      - CCD_MIRROR_PATH=/data/ccd
      - PDB_MIRROR_PATH=/data/pdb
      # HBPLUS for hydrogen bond analysis (RFD3 design-time constraints)
      - HBPLUS_PATH=/usr/local/bin/hbplus
    # Override command to start local API server
    command: ["python", "-u", "handler.py", "--rp_serve_api", "--rp_api_host", "0.0.0.0"]
    # GPU access - requires nvidia-docker2
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    # Keep container running for debugging
    stdin_open: true
    tty: true
