{
  "project": "Tb-Citrate AF3 Cross-Validation",
  "branchName": "ralph/af3-validation",
  "description": "Cross-validate all 173 production designs passing metal_binding filter through AlphaFold3 using a tiered seed strategy. Phase 1: screen all 173 with Ca+Tb variants (1 seed, noMSA, ~1.5 hours). Phase 2: re-validate hits with 3 seeds. Phase 3: final top candidates with 5 seeds + apo control. Generate cross-validation report comparing RF3 vs AF3 metrics.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Update af3_validate.py to support all 173 designs and noMSA mode",
      "description": "As a researcher, I want the AF3 validation script updated to: (1) load ALL 173 passing designs from production batch JSONs (not just top N), (2) support --noMSA flag that adds unpairedMsa field and sets --run_data_pipeline=false for fast screening, (3) support tiered seed counts (--seeds 1 for screening, 3 for validation, 5 for final), (4) support --variant ca_cit|tb_cit|apo|ca_tb to control which variants to generate, (5) generate run_all.sh with proper noMSA flags. The script already exists at experiments/ln_citrate_scaffold/af3_validate.py and handles top-N selection, Ca/Tb/apo variants, and analysis. It needs to be extended, not rewritten.",
      "acceptanceCriteria": [
        "af3_validate.py prepare --all --seeds 1 --noMSA generates 346 input JSONs (173 Ca + 173 Tb)",
        "af3_validate.py prepare --top 10 --seeds 5 still works as before (backwards compatible)",
        "Input JSONs include unpairedMsa field when --noMSA is set",
        "run_all.sh passes --run_data_pipeline=false when noMSA is enabled",
        "New --variant ca_tb option generates only Ca + Tb (no apo) for screening",
        "New --all flag loads all 173 passing designs instead of top N",
        "Manifest includes phase info (screening/validation/final)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "DONE. All 173 designs loaded, 346 input JSONs generated. noMSA field (unpairedMsa) added. --variant ca_tb works. Backward compatible with --top 10 --seeds 5. Phase-specific subdirectories created."
    },
    {
      "id": "US-002",
      "title": "Stop Docker and verify AF3 environment",
      "description": "As a researcher, I want to verify AF3 is ready to run by: (1) stopping the RFD3 Docker container to free the GPU, (2) verifying AF3 environment in WSL (venv, model checkpoint, databases), (3) running a quick smoke test with one design to confirm AF3 works end-to-end.",
      "acceptanceCriteria": [
        "Docker container serverless-rfdiffusion-1 is stopped",
        "nvidia-smi shows GPU free in WSL",
        "AF3 venv activates successfully (~/alphafold3_env/)",
        "AF3 model checkpoint exists (~/alphafold3_models/Complex_beta_ckpt.pt)",
        "One test design runs through AF3 successfully with --run_data_pipeline=false",
        "AF3 output contains _summary_confidences.json with ptm, iptm fields"
      ],
      "priority": 2,
      "passes": true,
      "notes": "DONE. Docker stopped. AF3 v3.0.1 in WSL verified. JAX upgraded to 0.5.3 + triton 3.6.0 for RTX 5090 Blackwell compatibility. --flash_attention_implementation=xla added to run_alphafold3.sh. Smoke test: b01_seq_0180_ca_cit got iPTM=0.87, pTM=0.88, ranking_score=0.88 (55s). noMSA requires unpairedMsa + pairedMsa + templates fields. UNC paths (//wsl.localhost/Ubuntu/...) used for cross-OS file access."
    },
    {
      "id": "US-003",
      "title": "Phase 1: Screen all 173 designs with Ca+Tb, 1 seed, noMSA",
      "description": "As a researcher, I want to screen all 173 passing production designs through AF3 with Ca-citrate and Tb-citrate variants using 1 seed and no MSA search, to quickly identify which designs AF3 validates as capable of metal-ligand binding.",
      "acceptanceCriteria": [
        "346 AF3 jobs completed (173 Ca-citrate + 173 Tb-citrate)",
        "Results parsed: iPTM, pTM, ranking_score extracted per job",
        "Ca-citrate hits identified (iPTM >= 0.8, pTM >= 0.7)",
        "Tb-citrate hits identified (iPTM >= 0.6, pTM >= 0.5)",
        "Phase 1 summary saved to analysis/af3_validation/phase1_screening.json",
        "Screen report printed: total hits, pass rates for Ca and Tb",
        "Total runtime logged"
      ],
      "priority": 3,
      "passes": true,
      "notes": "DONE. 346 AF3 jobs completed (341 batch + 5 pre-existing). Runtime: 46.9 min (batch mode via --input_dir, ~8.3s/job). Ca pass: 42/172 (24.4%), Tb pass: 133/172 (77.3%), Both: 41/172 (23.8%). RF3-AF3 correlation r=0.384. Results in phase1_screening.json."
    },
    {
      "id": "US-004",
      "title": "Phase 1 analysis: identify hits and set Phase 2 candidates",
      "description": "As a researcher, I want to analyze Phase 1 screening results, identify designs that pass AF3 validation, compare RF3 vs AF3 metrics, and select candidates for Phase 2 re-validation with more seeds.",
      "acceptanceCriteria": [
        "Analysis of Phase 1 results completed with pass/fail counts",
        "RF3 vs AF3 metric correlation computed (pTM, iPTM, pLDDT)",
        "Phase 2 candidate list generated: union of Ca-hits and Tb-hits",
        "If 0 designs pass strict Ca thresholds, relax to iPTM >= 0.6 and re-evaluate",
        "Summary table: rank, design_id, RF3_pTM, AF3_Ca_iPTM, AF3_Tb_iPTM, pass/fail",
        "Phase 2 candidate list saved to analysis/af3_validation/phase2_candidates.json",
        "Cumulative lessons updated if significant AF3 patterns detected"
      ],
      "priority": 4,
      "passes": true,
      "notes": "DONE. Ca pass: 42/172 (24.4%), Tb pass: 132/172 (76.7%). RF3-AF3 correlation r=0.40-0.42 (moderate). Ca and Tb iPTM nearly identical (mean 0.703 vs 0.705) â€” surprising, AF3 treats them similarly. CN does NOT predict AF3 success. Phase 2 candidates: 65 (Ca>=0.8 OR Tb>=0.8). cumulative_lessons.md updated."
    },
    {
      "id": "US-005",
      "title": "Phase 2: Re-validate hits with 3 seeds + apo control",
      "description": "As a researcher, I want to re-validate Phase 1 hits with 3 seeds each (Ca, Tb, and apo variants) to confirm results and measure consistency across seeds.",
      "acceptanceCriteria": [
        "Phase 2 candidates run with 3 seeds per variant (Ca, Tb, apo)",
        "Per-design consistency measured: std(iPTM) across seeds",
        "Apo control compared to holo: positive delta_pTM = AF3 recognizes binding",
        "Results saved to analysis/af3_validation/phase2_validation.json",
        "Designs with consistent high confidence identified for Phase 3"
      ],
      "priority": 5,
      "passes": true,
      "notes": "DONE. 65 candidates x 3 variants x 3 seeds = 195 jobs, 77.1 min. Ca pass: 53/65 (81.5%), Tb pass: 64/65 (98.5%), Both: 52/65 (80%). Avg holo-apo delta: +0.201 (strong binding recognition). Top deltas: b09_seq_0169 +0.610, b08_seq_0051 +0.580, b02_seq_0031 +0.540."
    },
    {
      "id": "US-006",
      "title": "Phase 3: Final top candidates with 5 seeds (full confidence)",
      "description": "As a researcher, I want to run the final top candidates (top 10 or fewer) with 5 seeds each for maximum confidence, producing the definitive ranking for experimental testing.",
      "acceptanceCriteria": [
        "Top 10 (or all if <10) candidates run with 5 seeds each",
        "Best model per design selected by AF3 ranking_score",
        "Final ranking produced combining RF3 + AF3 metrics",
        "Per-design report: RF3 pTM, AF3 Ca iPTM, AF3 Tb iPTM, apo delta, seed consistency",
        "Results saved to analysis/af3_validation/phase3_final.json"
      ],
      "priority": 6,
      "passes": true,
      "notes": "DONE. 10 x 3 variants x 5 seeds = 30 jobs, 21.4 min. 10/10 pass both Ca and Tb (100%). Ca iPTM 0.84-0.92, Tb iPTM 0.82-0.91. Avg holo-apo delta +0.151. Top: b02_seq_0105 (Ca=0.92), b09_seq_0016 (Ca=0.91, Tb=0.91), b01_seq_0094 (balanced 0.89/0.89)."
    },
    {
      "id": "US-007",
      "title": "Generate cross-validation report and update lessons",
      "description": "As a researcher, I want a comprehensive AF3 cross-validation report comparing RF3 vs AF3 metrics across all 173 designs, with recommendations for experimental testing and lessons learned about pipeline reliability.",
      "acceptanceCriteria": [
        "AF3_VALIDATION_REPORT.md written to experiments/ln_citrate_scaffold/final/",
        "Report includes: pipeline overview, phase summaries, metric correlations, final ranking",
        "RF3 vs AF3 scatter data included (for correlation analysis)",
        "Final recommended candidate list for gene synthesis",
        "cumulative_lessons.md updated with AF3 validation findings",
        "current_summary.md updated with AF3 cross-validation statistics",
        "Restart Docker container for future RFD3 use"
      ],
      "priority": 7,
      "passes": true,
      "notes": "DONE. AF3_VALIDATION_REPORT.md written to experiments/ln_citrate_scaffold/final/. Report includes pipeline overview, 3-phase summaries, RF3-AF3 correlations (r=0.40), final top-10 ranking table. cumulative_lessons.md updated with AF3 findings. current_summary.md updated with AF3 cross-validation statistics and top-5 candidates. Docker container restarted for future RFD3 use."
    }
  ]
}
